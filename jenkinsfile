pipeline {

agent any

environment {

    IMAGE_NAME='ssk1811/pollimage'

    IMAGE_TAG='latest'

}
stages {

stage('Checkout') {

steps {


checkout scm


}

}



stage('Build') {

steps {



sh 'dotnet build'

}

}
stage('SonarQube Analysis') {
            environment {
                scannerHome = tool 'qube'
            }
            steps {
                script {
                    withSonarQubeEnv('sq1') {
                        sh "dotnet ${scannerHome}/SonarScanner.MSBuild.dll begin /k:\"jenkins-trial\""
                        sh "dotnet build"
                        sh "dotnet ${scannerHome}/SonarScanner.MSBuild.dll end"
                    }
                }
            }
        }



stage('Docker Build'){
steps{
script{
docker.build("${IMAGE_NAME}:${IMAGE_TAG}")
}
}
}



stage('Docker Push'){

    steps{

        script{

            docker.withRegistry('https://index.docker.io/v1/','docker_login'){


                docker.image("${IMAGE_NAME}:${IMAGE_TAG}").push()

            }
        }

    }

}
stage('Run container') {

steps {

script{
    def existingContainer = docker.inspect("PollTrial")
    if(existingContainer!=null){
       sh 'docker stop PollTrial '
 sh'docker rm PollTrial'
    }


    sh "docker run -d --name PollTrial -p 1020:8080 ${IMAGE_NAME}:${IMAGE_TAG}"
}

}

}
}

}
